<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - TaskFlow</title>
  <link rel="stylesheet" href="../src/styles/global/global.css">
  <link rel="stylesheet" href="../src/features/admin/styles/admin.css">
  <link rel="stylesheet" href="../src/styles/shared/tags.css">
  <link rel="stylesheet" href="../src/features/admin/styles/kanban-settings.css">
</head>
<body>
  <!-- Navigation (injected by navbar component) -->

  <!-- Main Content -->
  <main class="admin-main">
    <div class="container py-6">
      <!-- Header -->
      <div class="admin-header mb-8">
        <h1 class="mb-2">Admin Panel</h1>
        <p class="text-muted">Manage team members, tags, and company settings.</p>
      </div>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="admin-tab-btn active" data-tab="team">
          <span>üë•</span> Team Members
        </button>
        <button class="admin-tab-btn" data-tab="tags">
          <span>üè∑Ô∏è</span> Tags
        </button>
        <button class="admin-tab-btn" data-tab="workflow">
          <span>‚öôÔ∏è</span> Workflow Settings
        </button>
        <button class="admin-tab-btn" data-tab="company">
          <span>üè¢</span> Company Settings
        </button>
        <button class="admin-tab-btn" data-tab="sysadmin" id="sysadminTab" style="display: none;">
          <span>‚öôÔ∏è</span> System Admin
        </button>
      </div>

      <!-- Team Tab -->
      <div class="admin-tab-content active" id="team-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Team Members</h3>
          </div>
          <div class="card-body" id="teamContainer">
            <p class="text-muted text-center">Loading team members...</p>
          </div>
        </div>
      </div>

      <!-- Tags Tab -->
      <div class="admin-tab-content" id="tags-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Manage Tags</h3>
            <p class="text-muted mb-0 mt-2" style="font-size: 0.875rem;">Create and manage tags for your team. Users can assign these tags to tasks.</p>
          </div>
          <div class="card-body" id="tagsContainer">
            <p class="text-muted text-center">Loading tags...</p>
          </div>
        </div>
      </div>

      <!-- Workflow Settings Tab -->
      <div class="admin-tab-content" id="workflow-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Workflow Settings</h3>
            <p class="text-muted mb-0 mt-2" style="font-size: 0.875rem;">Customize status columns for your Kanban board. Select a project to manage its workflow.</p>
          </div>
          <div class="card-body" id="workflowContainer">
            <p class="text-muted text-center">Loading workflow settings...</p>
          </div>
        </div>
      </div>

      <!-- Company Settings Tab -->
      <div class="admin-tab-content" id="company-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Company Settings</h3>
          </div>
          <div class="card-body" id="companyContainer">
            <p class="text-muted text-center">Company settings coming in Plan 08</p>
          </div>
        </div>
      </div>

      <!-- System Admin Tab (sys_admin only) -->
      <div class="admin-tab-content" id="sysadmin-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">System Administration</h3>
            <p class="text-muted mb-0 mt-2" style="font-size: 0.875rem;">Full access to all users and companies across the system.</p>
          </div>
          <div class="card-body" id="sysadminContainer">
            <p class="text-muted text-center">Loading system admin panel...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { renderNavbar } from '../src/shared/components/navbar.js';
    import { router } from '../src/shared/utils/router.js';
    import { authUtils } from '../src/shared/utils/auth.js';
    import { uiHelpers } from '../src/shared/utils/ui-helpers.js';
    import { renderTagManager } from '../src/features/admin/components/tag-manager-admin.js';
    import { renderTeamMemberManager } from '../src/features/admin/components/team/team-manager-admin.js';
    import { renderSystemAdminManager } from '../src/features/admin/components/sysadmin/system-admin-manager.js';
    import { renderWorkflowManager } from '../src/features/admin/components/workflow-manager-admin.js';
    import supabase from '../src/shared/services/supabase.js';

    let tagManagerInitialized = false;
    let teamManagerInitialized = false;
    let workflowManagerInitialized = false;
    let sysadminManagerInitialized = false;
    let isSysAdmin = false;

    async function init() {
      try {
        // Ensure user is authenticated and is admin
        await router.requireAdmin();

        // Render navbar
        await renderNavbar();

        // Load user info and check for sys_admin
        const metadata = await authUtils.getUserMetadata();
        console.log('Admin user:', metadata);

        // Check if user is sys_admin
        await checkSysAdmin();

        // Setup tab switching
        setupTabs();

        // Load tags on first load (since invites tab is active by default)
        // Tags will be loaded when user clicks the Tags tab
      } catch (error) {
        console.error('Admin page initialization error:', error);
        uiHelpers.showError('Failed to load admin panel. Please refresh the page.');
      }
    }

    async function checkSysAdmin() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: profile } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        isSysAdmin = profile?.role === 'sys_admin';

        // Show/hide sys_admin tab
        const sysadminTab = document.getElementById('sysadminTab');
        if (sysadminTab && isSysAdmin) {
          sysadminTab.style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking sys_admin status:', error);
      }
    }

    function setupTabs() {
      const tabButtons = document.querySelectorAll('.admin-tab-btn');
      const tabContents = document.querySelectorAll('.admin-tab-content');

      console.log('Setting up tabs:', tabButtons.length, 'buttons found');
      console.log('Tab contents:', tabContents.length, 'content areas found');

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', async () => {
          const tabName = btn.getAttribute('data-tab');
          console.log('Tab clicked:', tabName);

          // Remove active from all buttons and contents
          tabButtons.forEach((b) => b.classList.remove('active'));
          tabContents.forEach((c) => c.classList.remove('active'));

          // Add active to clicked button and corresponding content
          btn.classList.add('active');
          const tabContent = document.getElementById(tabName + '-tab');
          if (tabContent) {
            tabContent.classList.add('active');
            console.log('Activated tab content:', tabName + '-tab');
          } else {
            console.error('Tab content not found:', tabName + '-tab');
          }

          // Load tab-specific content
          if (tabName === 'team' && !teamManagerInitialized) {
            console.log('Loading team manager...');
            await loadTeamManager();
          } else if (tabName === 'tags' && !tagManagerInitialized) {
            console.log('Loading tag manager...');
            await loadTagManager();
          } else if (tabName === 'workflow' && !workflowManagerInitialized) {
            console.log('Loading workflow manager...');
            await loadWorkflowManager();
          } else if (tabName === 'sysadmin' && !sysadminManagerInitialized) {
            console.log('Loading system admin manager...');
            await loadSysAdminManager();
          }
        });
      });

      // Load team manager by default on page load
      console.log('Loading team manager on page load...');
      loadTeamManager();
    }

    async function loadTeamManager() {
      const teamContainer = document.getElementById('teamContainer');
      console.log('loadTeamManager - container found:', !!teamContainer);

      if (!teamContainer) {
        console.error('Team container not found!');
        return;
      }

      teamContainer.innerHTML = '<p class="text-center">Loading team members...</p>';

      try {
        console.log('Calling renderTeamMemberManager...');
        await renderTeamMemberManager(teamContainer);
        teamManagerInitialized = true;
        console.log('Team manager loaded successfully');
      } catch (error) {
        console.error('Failed to load team manager:', error);
        teamContainer.innerHTML = `
          <div class="alert alert-danger">
            <h5>Failed to load team manager</h5>
            <p>${error.message || 'Unknown error'}</p>
            <button class="btn btn-sm btn-primary" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    async function loadTagManager() {
      const tagsContainer = document.getElementById('tagsContainer');
      if (!tagsContainer) return;

      try {
        await renderTagManager(tagsContainer);
        tagManagerInitialized = true;
      } catch (error) {
        console.error('Failed to load tag manager:', error);
        tagsContainer.innerHTML = `
          <div class="text-center text-danger">
            <p>Failed to load tag manager</p>
            <button class="btn btn-sm btn-primary" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    async function loadWorkflowManager() {
      const workflowContainer = document.getElementById('workflowContainer');
      if (!workflowContainer) return;

      try {
        await renderWorkflowManager(workflowContainer);
        workflowManagerInitialized = true;
      } catch (error) {
        console.error('Failed to load workflow manager:', error);
        workflowContainer.innerHTML = `
          <div class="text-center text-danger">
            <p>Failed to load workflow manager</p>
            <button class="btn btn-sm btn-primary" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    async function loadSysAdminManager() {
      const sysadminContainer = document.getElementById('sysadminContainer');
      if (!sysadminContainer) return;

      if (!isSysAdmin) {
        sysadminContainer.innerHTML = `
          <div class="alert alert-danger">
            <p>Access denied. System admin privileges required.</p>
          </div>
        `;
        return;
      }

      try {
        await renderSystemAdminManager(sysadminContainer);
        sysadminManagerInitialized = true;
      } catch (error) {
        console.error('Failed to load system admin manager:', error);
        sysadminContainer.innerHTML = `
          <div class="text-center text-danger">
            <p>Failed to load system admin manager</p>
            <button class="btn btn-sm btn-primary" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    init();
  </script>
</body>
</html>
