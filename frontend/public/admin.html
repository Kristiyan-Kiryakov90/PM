<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - TaskFlow</title>
  <link rel="stylesheet" href="../src/css/global.css">
  <link rel="stylesheet" href="../src/css/admin.css">
  <link rel="stylesheet" href="../src/css/tags.css">
</head>
<body>
  <!-- Navigation (injected by navbar component) -->

  <!-- Main Content -->
  <main class="admin-main">
    <div class="container py-6">
      <!-- Header -->
      <div class="admin-header mb-8">
        <h1 class="mb-2">Admin Panel</h1>
        <p class="text-muted">Manage company settings, invites, and team members.</p>
      </div>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="admin-tab-btn active" data-tab="invites">
          <span>ğŸ“§</span> Invitations
        </button>
        <button class="admin-tab-btn" data-tab="team">
          <span>ğŸ‘¥</span> Team Members
        </button>
        <button class="admin-tab-btn" data-tab="tags">
          <span>ğŸ·ï¸</span> Tags
        </button>
        <button class="admin-tab-btn" data-tab="company">
          <span>ğŸ¢</span> Company Settings
        </button>
      </div>

      <!-- Invitations Tab -->
      <div class="admin-tab-content active" id="invites-tab">
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="card-title mb-0">Send Invitations</h3>
              <button class="btn btn-primary btn-sm" id="newInviteBtn">
                <span>â•</span> Invite User
              </button>
            </div>
          </div>
          <div class="card-body" id="invitesContainer">
            <p class="text-muted text-center">No pending invitations yet.</p>
          </div>
        </div>
      </div>

      <!-- Team Tab -->
      <div class="admin-tab-content" id="team-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Team Members</h3>
          </div>
          <div class="card-body" id="teamContainer">
            <p class="text-muted text-center">Loading team members...</p>
          </div>
        </div>
      </div>

      <!-- Tags Tab -->
      <div class="admin-tab-content" id="tags-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Manage Tags</h3>
            <p class="text-muted mb-0 mt-2" style="font-size: 0.875rem;">Create and manage tags for your team. Users can assign these tags to tasks.</p>
          </div>
          <div class="card-body" id="tagsContainer">
            <p class="text-muted text-center">Loading tags...</p>
          </div>
        </div>
      </div>

      <!-- Company Settings Tab -->
      <div class="admin-tab-content" id="company-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Company Settings</h3>
          </div>
          <div class="card-body" id="companyContainer">
            <p class="text-muted text-center">Company settings coming in Plan 08</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { renderNavbar } from '../src/js/components/navbar.js';
    import { requireAdmin } from '../src/js/utils/router.js';
    import { getUserMetadata } from '../src/js/utils/auth.js';
    import { showError, showInfo } from '../src/js/utils/ui-helpers.js';
    import { renderTagManager } from '../src/js/components/tag-manager-admin.js';

    let tagManagerInitialized = false;

    async function init() {
      try {
        // Ensure user is authenticated and is admin
        await requireAdmin();

        // Render navbar
        await renderNavbar();

        // Load user info
        const metadata = await getUserMetadata();
        console.log('Admin user:', metadata);

        // Setup tab switching
        setupTabs();

        // Load tags on first load (since invites tab is active by default)
        // Tags will be loaded when user clicks the Tags tab
      } catch (error) {
        console.error('Admin page initialization error:', error);
        showError('Failed to load admin panel. Please refresh the page.');
      }
    }

    function setupTabs() {
      const tabButtons = document.querySelectorAll('.admin-tab-btn');
      const tabContents = document.querySelectorAll('.admin-tab-content');

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', async () => {
          const tabName = btn.getAttribute('data-tab');

          // Remove active from all buttons and contents
          tabButtons.forEach((b) => b.classList.remove('active'));
          tabContents.forEach((c) => c.classList.remove('active'));

          // Add active to clicked button and corresponding content
          btn.classList.add('active');
          document.getElementById(tabName + '-tab').classList.add('active');

          // Load tab-specific content
          if (tabName === 'tags' && !tagManagerInitialized) {
            await loadTagManager();
          }
        });
      });

      // Setup invite button
      const newInviteBtn = document.getElementById('newInviteBtn');
      if (newInviteBtn) {
        newInviteBtn.addEventListener('click', () => {
          showInfo('Invite functionality coming in Plan 08');
        });
      }
    }

    async function loadTagManager() {
      const tagsContainer = document.getElementById('tagsContainer');
      if (!tagsContainer) return;

      try {
        await renderTagManager(tagsContainer);
        tagManagerInitialized = true;
      } catch (error) {
        console.error('Failed to load tag manager:', error);
        tagsContainer.innerHTML = `
          <div class="text-center text-danger">
            <p>Failed to load tag manager</p>
            <button class="btn btn-sm btn-primary" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    init();
  </script>
</body>
</html>
