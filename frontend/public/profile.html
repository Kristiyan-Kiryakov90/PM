<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - TaskFlow</title>
  <link rel="stylesheet" href="../src/styles/global/global.css">
  <link rel="stylesheet" href="../src/styles/shared/profile.css">
</head>
<body>
  <!-- Navigation (injected by navbar component) -->

  <!-- Main Content -->
  <main class="profile-main">
    <div class="container py-6">
      <!-- Header -->
      <div class="profile-header mb-8">
        <h1 class="mb-2">Profile Settings</h1>
        <p class="text-muted">Manage your account and preferences.</p>
      </div>

      <!-- Profile Tabs -->
      <div class="profile-tabs">
        <button class="profile-tab-btn active" data-tab="account">
          <span>üë§</span> Account
        </button>
        <button class="profile-tab-btn" data-tab="preferences">
          <span>‚öôÔ∏è</span> Preferences
        </button>
        <button class="profile-tab-btn" data-tab="security">
          <span>üîí</span> Security
        </button>
      </div>

      <!-- Account Tab -->
      <div class="profile-tab-content active" id="account-tab">
        <div class="row">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title mb-0">Profile Information</h3>
              </div>
              <div class="card-body">
                <form id="profileForm" class="space-y-4">
                  <div class="form-group">
                    <label for="firstName" class="form-label">First Name</label>
                    <input type="text" class="form-control" id="firstName" required>
                  </div>

                  <div class="form-group">
                    <label for="lastName" class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="lastName" required>
                  </div>

                  <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email" disabled>
                    <small class="form-text">Email cannot be changed</small>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Role</label>
                    <div class="form-control" id="roleDisplay" style="background-color: var(--gray-100); cursor: not-allowed;">
                      <span id="roleText">Loading...</span>
                    </div>
                    <small class="form-text">Contact an administrator to change your role</small>
                  </div>

                  <button type="submit" class="btn btn-primary w-100">
                    Save Changes
                  </button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title mb-0">Profile Picture</h3>
              </div>
              <div class="card-body text-center">
                <div class="profile-avatar mb-4">
                  <div id="profileAvatarBig" class="avatar-display">U</div>
                </div>
                <p class="text-muted small mb-4">Avatar coming soon</p>
                <button type="button" class="btn btn-outline-primary" disabled>
                  Upload Picture
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Preferences Tab -->
      <div class="profile-tab-content" id="preferences-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">User Preferences</h3>
          </div>
          <div class="card-body">
            <p class="text-muted text-center">Preference settings coming soon</p>
          </div>
        </div>
      </div>

      <!-- Security Tab -->
      <div class="profile-tab-content" id="security-tab">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Change Password</h3>
          </div>
          <div class="card-body">
            <form id="passwordForm" class="space-y-4" style="max-width: 500px;">
              <div class="form-group">
                <label for="currentPassword" class="form-label">Current Password</label>
                <input type="password" class="form-control" id="currentPassword" required>
              </div>

              <div class="form-group">
                <label for="newPassword" class="form-label">New Password</label>
                <input type="password" class="form-control" id="newPassword" required>
                <small class="form-text">At least 8 characters with uppercase, lowercase, and number</small>
              </div>

              <div class="form-group">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirmPassword" required>
              </div>

              <button type="submit" class="btn btn-primary">
                Update Password
              </button>
            </form>
          </div>
        </div>

        <div class="card mt-6">
          <div class="card-header">
            <h3 class="card-title mb-0 text-danger">‚ö†Ô∏è Danger Zone</h3>
          </div>
          <div class="card-body">
            <div class="alert alert-warning mb-4">
              <strong>Warning:</strong> Deleting your account is permanent and cannot be undone. All your data will be lost.
            </div>
            <p class="text-muted mb-4">Once you delete your account, there is no going back. Please be certain.</p>
            <button type="button" class="btn btn-danger" id="deleteAccountBtn">
              üóëÔ∏è Delete My Account
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { renderNavbar } from '../src/shared/components/navbar.js';
    import { router } from '../src/shared/utils/router.js';
    import { authUtils } from '../src/shared/utils/auth.js';
    import { uiHelpers } from '../src/shared/utils/ui-helpers.js';
    import { profileService } from '../src/shared/services/profile-service.js';
    import supabase from '../src/shared/services/supabase.js';

    let currentUserEmail = '';

    async function init() {
      try {
        // Ensure user is authenticated
        await router.requireAuth();

        // Render navbar
        await renderNavbar();

        // Load user profile data
        await loadProfileData();

        // Setup tab switching
        setupTabs();

        // Setup form submissions
        setupForms();

        // Setup delete account button
        setupDeleteAccount();
      } catch (error) {
        console.error('Profile page initialization error:', error);
        uiHelpers.showError('Failed to load profile. Please refresh the page.');
      }
    }

    async function loadProfileData() {
      try {
        const metadata = await authUtils.getUserMetadata();
        const fullName = await authUtils.getUserFullName();

        // Store email for delete confirmation
        currentUserEmail = metadata.email || '';

        // Populate form fields
        document.getElementById('firstName').value = metadata.first_name || '';
        document.getElementById('lastName').value = metadata.last_name || '';
        document.getElementById('email').value = currentUserEmail;
        document.getElementById('roleText').textContent = metadata.role || 'user';

        // Update avatar
        const initials = fullName
          .split(' ')
          .slice(0, 2)
          .map((p) => p[0])
          .join('')
          .toUpperCase();
        document.getElementById('profileAvatarBig').textContent = initials;
      } catch (error) {
        console.error('Error loading profile data:', error);
        uiHelpers.showError('Failed to load profile information.');
      }
    }

    function setupTabs() {
      const tabButtons = document.querySelectorAll('.profile-tab-btn');
      const tabContents = document.querySelectorAll('.profile-tab-content');

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const tabName = btn.getAttribute('data-tab');

          // Remove active from all buttons and contents
          tabButtons.forEach((b) => b.classList.remove('active'));
          tabContents.forEach((c) => c.classList.remove('active'));

          // Add active to clicked button and corresponding content
          btn.classList.add('active');
          document.getElementById(tabName + '-tab').classList.add('active');
        });
      });
    }

    function setupForms() {
      const profileForm = document.getElementById('profileForm');
      const passwordForm = document.getElementById('passwordForm');

      if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          await handleProfileUpdate();
        });
      }

      if (passwordForm) {
        passwordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          await handlePasswordChange();
        });
      }
    }

    async function handleProfileUpdate() {
      const submitBtn = document.querySelector('#profileForm button[type="submit"]');

      try {
        uiHelpers.disableButton(submitBtn, 'Saving...');

        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();

        await profileService.updateProfile({
          first_name: firstName,
          last_name: lastName,
        });

        uiHelpers.showSuccess('Profile updated successfully');

        // Reload profile data to refresh UI
        await loadProfileData();
      } catch (error) {
        console.error('Error updating profile:', error);
        uiHelpers.showError(error.message || 'Failed to update profile');
      } finally {
        uiHelpers.enableButton(submitBtn);
      }
    }

    async function handlePasswordChange() {
      const submitBtn = document.querySelector('#passwordForm button[type="submit"]');

      try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validate passwords match
        if (newPassword !== confirmPassword) {
          uiHelpers.showError('New password and confirmation do not match');
          return;
        }

        uiHelpers.disableButton(submitBtn, 'Updating...');

        await profileService.changePassword(newPassword);

        uiHelpers.showSuccess('Password changed successfully');

        // Clear form
        document.getElementById('passwordForm').reset();
      } catch (error) {
        console.error('Error changing password:', error);
        uiHelpers.showError(error.message || 'Failed to change password');
      } finally {
        uiHelpers.enableButton(submitBtn);
      }
    }

    function setupDeleteAccount() {
      const deleteBtn = document.getElementById('deleteAccountBtn');

      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          await handleDeleteAccount();
        });
      }
    }

    async function handleDeleteAccount() {
      // First confirmation
      const confirmed = confirm(
        '‚ö†Ô∏è WARNING: This action cannot be undone!\n\n' +
        'Are you absolutely sure you want to permanently delete your account?\n\n' +
        'All your projects, tasks, comments, and data will be lost forever.\n\n' +
        'Click OK to proceed with account deletion.'
      );

      if (!confirmed) {
        return;
      }

      // Second confirmation with email verification
      const emailConfirmation = prompt(
        `To confirm deletion, please type your email address:\n${currentUserEmail}`
      );

      if (!emailConfirmation) {
        uiHelpers.showInfo('Account deletion cancelled');
        return;
      }

      if (emailConfirmation.trim() !== currentUserEmail) {
        uiHelpers.showError('Email confirmation does not match. Account deletion cancelled.');
        return;
      }

      const deleteBtn = document.getElementById('deleteAccountBtn');
      uiHelpers.disableButton(deleteBtn, 'Deleting Account...');

      try {
        // Call edge function to delete account
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error('No active session');

        console.log('Calling delete-own-account with token:', session.access_token.substring(0, 20) + '...');

        const response = await fetch(
          `${supabase.supabaseUrl}/functions/v1/delete-own-account`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json',
              'apikey': supabase.supabaseKey,
            },
            body: JSON.stringify({
              confirmEmail: currentUserEmail,
            }),
          }
        );

        const result = await response.json();
        console.log('Delete response:', result);

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to delete account');
        }

        // Account deleted successfully - sign out and redirect
        uiHelpers.showSuccess('Your account has been permanently deleted. Goodbye!');

        // Wait a moment for user to see the message
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Sign out
        await supabase.auth.signOut();

        // Redirect to landing page
        window.location.href = '/public/index.html';
      } catch (error) {
        console.error('Error deleting account:', error);
        uiHelpers.showError(error.message || 'Failed to delete account');
        uiHelpers.enableButton(deleteBtn);
      }
    }

    init();
  </script>
</body>
</html>
